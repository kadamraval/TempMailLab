rules_version = '2';

// Helper function to check for admin role
function isAdmin() {
  // In a real app, you would check a custom claim or a role field in the user's document.
  // For now, we will assume an 'role' field exists on the user document.
  // return request.auth.token.admin === true;
  return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

// Helper function to check if the user is the owner of a document.
// This is more secure than passing the userId from the client.
function isOwner(userId) {
  return request.auth != null && request.auth.uid == userId;
}

service cloud.firestore {
  match /databases/{database}/documents {

    // USER DATA
    // Users can read their own profile. Admins can read any profile.
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow create, update, delete: if isAdmin();
    }
    
    // INBOXES & EMAILS
    // Users can only manage their own inboxes and the emails within them.
    // This uses a `get()` call to check the `userId` field on the inbox/email document itself.
    match /inboxes/{inboxId} {
       allow read, write, delete: if isOwner(get(/databases/$(database)/documents/inboxes/$(inboxId)).data.userId);
    }
    match /emails/{emailId} {
      // This assumes an email document has a userId field.
      allow read, write, delete: if isOwner(get(/databases/$(database)/documents/emails/$(emailId)).data.userId);
    }

    // API KEYS
    // Users can manage their own API keys.
    match /api_keys/{apiKeyId} {
      allow read, create, delete: if isOwner(get(/databases/$(database)/documents/api_keys/$(apiKeyId)).data.userId);
    }

    // USAGE LOGS
    // Only readable by admins. Writes should be handled by a secure server environment.
    match /usage_logs/{usageLogId} {
       allow read: if isAdmin();
       allow write: if false; // Disallow client-side writes
    }

    // ADMIN-ONLY COLLECTIONS
    // Only users with an 'admin' role can read or write to these collections.
    match /blocked_ips/{blockedIpId} {
      allow read, write: if isAdmin();
    }
    match /blocked_domains/{blockedDomainId} {
      allow read, write: if isAdmin();
    }
    match /admin_settings/{settingId} {
      allow read, write: if isAdmin();
    }

    // --- PUBLIC & SEMI-PUBLIC COLLECTIONS ---

    // ALLOWED DOMAINS
    // Any authenticated user can read the list of allowed domains.
    // Only admins can create, update, or delete them.
    match /allowed_domains/{domainId} {
      allow get: if request.auth != null;
      allow list: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }
    
    // PLANS
    // Anyone (including unauthenticated users) can read the list of plans.
    // This is necessary for the public pricing page.
    match /plans {
        allow list, get: if true;
    }
    // Only admins can create, update, or delete a specific plan.
    match /plans/{planId} {
        allow get: if true; // Allow reading a single plan
        allow create, update, delete: if isAdmin();
    }
  }
}
