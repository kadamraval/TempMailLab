
/**
 * @fileoverview Firestore Security Rules for TempInbox application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles, inboxes, emails, and API keys.
 * Only the authenticated user can access their own data. API key usage logs are associated with API keys and can only be written to.
 * Blocked IPs and domains are managed globally.
 * Admin-only actions are controlled via a custom claim.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //============================================
    // Helper Functions
    //============================================
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      // In production, this claim must be set on the user via a trusted backend.
      return isSignedIn() && request.auth.token.isAdmin == true;
    }

    function isExistingOwner(userId) { 
      return isOwner(userId) && resource != null; 
    }

    //============================================
    // User Data
    //============================================
    match /users/{userId} {
      allow get: if isOwner(userId);
      // Only admins can list all users for the dashboard.
      allow list: if isAdmin();

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      /**
       * @description Enforces read and write access to inboxes based on user ownership.
       * @path /users/{userId}/inboxes/{inboxId}
       */
      match /inboxes/{inboxId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);

        /**
         * @description Enforces read and write access to emails based on user ownership of parent inbox.
         * @path /users/{userId}/inboxes/{inboxId}/emails/{emailId}
         */
        match /emails/{emailId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isSignedIn() && isOwner(userId);
          allow update: if isExistingOwner(userId);
          allow delete: if isExistingOwner(userId);
        }
      }
      
      /**
       * @description Enforces read and write access to API keys based on user ownership.
       * @path /users/{userId}/api_keys/{apiKeyId}
       */
      match /api_keys/{apiKeyId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }
    }

    //============================================
    // Public & Admin Collections
    //============================================
    
    match /plans/{planId} {
      // Anyone can read plans for the pricing page.
      allow get, list: if true;
      // Only admins can change plans.
      allow write: if isAdmin();
    }

    match /allowed_domains/{allowedDomainId} {
      // Anyone can read the list of domains available.
      allow get, list: if true;
      // Only admins can manage the domain pool.
      allow write: if isAdmin();
    }
    
    match /admin_settings/{settingId} {
      allow read, write: if isAdmin();
    }

    /**
     * @description Denies all access to API key usage logs. Intended for backend writes only.
     * @path /api_keys/{apiKeyId}/usage_logs/{usageLogId}
     */
    match /api_keys/{apiKeyId}/usage_logs/{usageLogId} {
      allow read, write: if false;
    }

    /**
     * @description Publicly readable collections for blocklists. Writable only by admins.
     * @path /blocked_ips/{blockedIpId}, /blocked_domains/{blockedDomainId}
     */
    match /blocked_ips/{blockedIpId} {
      allow get: if true;
      allow list: if true;
      allow write: if isAdmin();
    }

    match /blocked_domains/{blockedDomainId} {
      allow get: if true;
      allow list: if true;
      allow write: if isAdmin();
    }
  }
}
