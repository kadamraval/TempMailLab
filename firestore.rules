/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles, inboxes, and emails.
 * All data is nested under /users/{userId}, ensuring that only the authenticated user can access their own data.
 * API plans are publicly readable. API Key usage logs are stored under each user's path, restricted to owner access.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only to the authenticated user with matching UID.
 * - /users/{userId}/inboxes/{inboxId}: Temporary inboxes owned by the user.
 * - /users/{userId}/inboxes/{inboxId}/emails/{emailId}: Emails within the temporary inboxes.
 * - /api_plans/{apiPlanId}: Publicly readable API plans.
 * - /users/{userId}/api_key_usage/{apiKeyUsageId}: API key usage logs, restricted to the user.
 *
 * Key Security Decisions:
 * - Strict user-ownership is enforced via path-based matching in /users/{userId} and its subcollections.
 * - No user listing is allowed to prevent unauthorized data exposure.
 * - Public read access is granted to /api_plans/{apiPlanId}.
 * - The structure avoids `get()` calls by using path-based authorization.
 *
 * Denormalization for Authorization:
 * - The userId is embedded in the path for inboxes and emails, allowing direct authorization without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines the isSignedIn helper function.
     * @returns {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Defines the isOwner helper function.
     * @param {string} userId - The user ID to compare against the request's authentication UID.
     * @returns {boolean} True if the provided userId matches the authenticated user's UID, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Defines the isExistingOwner helper function.
     * @param {string} userId - The user ID to compare against the request's authentication UID.
     * @returns {boolean} True if the provided userId matches the authenticated user's UID and the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    // --- Publicly Readable Collections ---
    match /plans/{planId} {
      allow get, list: if true;
      allow write: if false; 
    }

    /**
     * @description Security rules for user profiles.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile if the userId matches their auth UID.
     * @allow (get, update, delete) - Authenticated user accesses their own profile if the userId matches their auth UID.
     * @deny (create) - Unauthenticated user attempts to create a profile.
     * @deny (get, update, delete) - Authenticated user attempts to access another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing of all user documents

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id; // Enforce immutability of userId
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for temporary inboxes for each user.
     * @path /users/{userId}/inboxes/{inboxId}
     * @allow (create) - Authenticated user creates an inbox under their own profile.
     * @allow (get, update, delete) - Authenticated user accesses their own inboxes.
     * @deny (create) - Unauthenticated user attempts to create an inbox.
     * @deny (get, update, delete) - Authenticated user attempts to access another user's inbox.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/inboxes/{inboxId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for emails within temporary inboxes.
     * @path /users/{userId}/inboxes/{inboxId}/emails/{emailId}
     * @allow (create) - Authenticated user creates an email within their own inbox.
     * @allow (get, update, delete) - Authenticated user accesses their own emails.
     * @deny (create) - Unauthenticated user attempts to create an email.
     * @deny (get, update, delete) - Authenticated user attempts to access another user's emails.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/inboxes/{inboxId}/emails/{emailId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for API plans.
     * @path /api_plans/{apiPlanId}
     * @allow (get, list) - Public read access to API plans.
     * @deny (create, update, delete) - Only admins can modify API plans (TODO: Implement admin role).
     * @principle Grants public read access while restricting write access to authorized users.
     */
    match /api_plans/{apiPlanId} {
      allow get, list: if true;

      allow create, update, delete: if false; // TODO: Add admin validation
    }

    /**
     * @description Security rules for API key usage logs for each user.
     * @path /users/{userId}/api_key_usage/{apiKeyUsageId}
     * @allow (create) - Authenticated user creates an API key usage log under their own profile.
     * @allow (get, update, delete) - Authenticated user accesses their own API key usage logs.
     * @deny (create) - Unauthenticated user attempts to create an API key usage log.
     * @deny (get, update, delete) - Authenticated user attempts to access another user's API key usage logs.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/api_key_usage/{apiKeyUsageId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}
